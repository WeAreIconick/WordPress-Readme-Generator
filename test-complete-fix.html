<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Fix Test - No Modals + File Parsing</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-container { max-width: 900px; margin: 0 auto; }
        .test-section { border: 1px solid #ccc; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .success { background: #e8f5e8; color: #2e7d32; border-color: #4caf50; }
        .error { background: #ffebee; color: #c62828; border-color: #f44336; }
        .warning { background: #fff3e0; color: #ef6c00; border-color: #ff9800; }
        .code { background: #f5f5f5; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .inline-preview { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .preview-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn-primary { background: #007cba; color: white; }
        .btn-secondary { background: #f1f3f4; color: #3c4043; border: 1px solid #dadce0; }
        .btn:hover { opacity: 0.8; }
        .form-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .file-input { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 3px; width: 100%; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Complete Fix Test - No Modals + File Parsing</h1>
        
        <div class="test-section">
            <h3>Test Results</h3>
            <div id="testResults"></div>
        </div>

        <!-- WordPress Readme Generator Form (Simulated) -->
        <div class="wp-block-telex-block-wordpress-readme-generator-frontend">
            <div class="readme-generator-form">
                <!-- File Upload Section -->
                <div class="form-section file-upload-section">
                    <h3>Import Existing Readme</h3>
                    <div class="form-row">
                        <label for="readmeFile">Upload readme.txt file (optional)</label>
                        <input type="file" id="readmeFile" accept=".txt" class="file-input">
                        <small>Choose an existing readme.txt file to populate the form fields automatically. Max size: 100KB</small>
                    </div>
                </div>

                <form id="readmeForm">
                    <div class="form-section">
                        <h3>Basic Information</h3>
                        
                        <div class="form-row">
                            <label for="pluginName">Plugin Name</label>
                            <input type="text" id="pluginName" name="pluginName" placeholder="My Awesome Plugin" maxlength="100">
                        </div>

                        <div class="form-row">
                            <label for="shortDescription">Short Description</label>
                            <textarea id="shortDescription" name="shortDescription" rows="3" placeholder="A brief description..." maxlength="150"></textarea>
                        </div>

                        <div class="form-row">
                            <label for="contributors">Contributors</label>
                            <input type="hidden" id="contributors" name="contributors">
                            <div id="contributorsDisplay"></div>
                        </div>

                        <div class="form-row">
                            <label for="tags">Tags</label>
                            <input type="hidden" id="tags" name="tags">
                            <div id="tagsDisplay"></div>
                        </div>

                        <div class="form-row">
                            <label for="version">Version</label>
                            <input type="text" id="version" name="version" placeholder="1.0.0" maxlength="20">
                        </div>

                        <div class="form-row">
                            <label for="requiresAtLeast">Requires WordPress</label>
                            <select id="requiresAtLeast" name="requiresAtLeast">
                                <option value="5.0">5.0</option>
                                <option value="6.0">6.0</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <label for="testedUpTo">Tested up to</label>
                            <select id="testedUpTo" name="testedUpTo">
                                <option value="6.8">6.8</option>
                                <option value="6.7">6.7</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <label for="requiresPHP">Requires PHP</label>
                            <select id="requiresPHP" name="requiresPHP">
                                <option value="7.4">7.4</option>
                                <option value="8.0">8.0</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="6" placeholder="Detailed description..." maxlength="5000"></textarea>
                        </div>

                        <div class="form-row">
                            <label for="installation">Installation</label>
                            <textarea id="installation" name="installation" rows="4" placeholder="Installation instructions..." maxlength="2000"></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="previewBtn" class="btn btn-secondary">Preview</button>
                        <button type="button" id="downloadBtn" class="btn btn-primary">Download</button>
                    </div>
                </form>

                <!-- Inline Preview Section (NOT a modal) -->
                <div class="form-section inline-preview" id="previewSection" style="display: none;">
                    <h3>Readme Preview</h3>
                    <div class="code" id="previewContent"></div>
                    <div class="preview-actions">
                        <button id="hidePreviewBtn" class="btn btn-secondary">Hide Preview</button>
                        <button id="downloadBtnPreview" class="btn btn-primary">Download readme.txt</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>Test Actions</h3>
            <button class="btn btn-primary" id="testFileBtn">Test File Upload</button>
            <button class="btn btn-primary" id="testPreviewBtn">Test Inline Preview</button>
            <button class="btn btn-primary" id="checkModalBtn">Check for Modals</button>
        </div>

        <div class="test-section">
            <h3>Debug Info</h3>
            <div class="code" id="debugInfo"></div>
        </div>
    </div>

    <script>
        // Sample readme content from the attached file
        const sampleReadme = `=== Content Randomizer - Rotate Any Block ===
Contributors: slaFFik
Tags: randomizer, rotation, gutenberg, dynamic-content, testimonials
Requires at least: 6.7
Requires PHP: 7.4
Tested up to: 6.8
Stable tag: 1.2.0
License: GPL-2.0-or-later

Rotate and display random content blocks on every page load. Perfect for testimonials, CTAs, and dynamic content. Works with any block type.

== Description ==

Blocks Randomizer adds dynamic variety to your website by randomly displaying blocks from a collection you define. Simply add the "Blocks Randomizer" container block to any page or post, fill it with your desired content blocks, and the plugin will automatically select and display one (or more) randomly each time the page loads.

Perfect for creating fresh, engaging experiences for repeat visitors without manually updating content.

### Key Features

* **Easy to Use**: Works seamlessly with the WordPress Block Editor (Gutenberg)
* **Flexible Content**: Add any type of block as a child - paragraphs, images, headings, galleries, custom blocks, and more
* **Multiple Display Options**: Choose how many random blocks to show at once
* **No Coding Required**: Simple drag-and-drop interface for managing randomized content
* **Performance Optimized**: Lightweight and efficient randomization

== Installation ==

This section describes how to install the plugin and get it working.

**Install through your backend**:

1. Install the plugin via Plugins -> New plugin. Search for "blocks randomizer".
1. Click the "Install Now" button, and then - "Activate".

**Install manually**:

1. Download and unzip the plugin.
1. Upload the \`blocks-randomizer\` directory to the \`/wp-content/plugins/\` directory.
1. Activate the plugin through the "Plugins" menu in WordPress.

== Frequently Asked Questions ==

### How do I add the Blocks Randomizer to my page?

In the Block Editor, type the slash \`/random\` and select the "Blocks Randomizer" block. Then use the "+" button inside of it to add any blocks you want to be randomized on each page load.

### Can I randomize any type of block?

Yes, any block that you see in your Block Editor can be used inside our Blocks Randomizer.

== Changelog ==

= 1.2.0 =
* Changed: You can now set the number of items inside the randomizer block to 0, effectively hiding the whole block on the front-end (and everything inside it).
* Changed: Do not allow putting the Randomizer block inside the Randomizer block. You don't want to go deeper.

= 1.1.0 =
* Added: New option - Number of child blocks to display.

= 1.0.0 =
* Added: New parent container to store all your randomly selected blocks: Blocks Randomizer`;

        // Enhanced parsing function
        function parseReadmeContent(content) {
            const result = {
                pluginName: '',
                contributors: '',
                tags: '',
                requiresAtLeast: '',
                requiresPHP: '',
                testedUpTo: '',
                stableTag: '',
                license: '',
                shortDescription: '',
                description: '',
                installation: '',
                faqs: [],
                changelog: []
            };

            try {
                const lines = content.split('\n');
                let inHeader = false;
                let currentSection = '';
                let sectionContent = [];

                for (let i = 0; i < lines.length; i++) {
                    const line = (lines[i] || '').trim();
                    
                    // Start of header
                    if (line.match(/^===.*===$/)) {
                        result.pluginName = line.replace(/^===/, '').replace(/===$/, '').trim();
                        inHeader = true;
                        continue;
                    }

                    // End of header - look for empty line followed by content (not section markers)
                    if (inHeader && line === '') {
                        // Check if next non-empty line is not a section marker
                        let nextLineIndex = i + 1;
                        while (nextLineIndex < lines.length && (lines[nextLineIndex] || '').trim() === '') {
                            nextLineIndex++;
                        }
                        
                        if (nextLineIndex < lines.length) {
                            const nextLine = (lines[nextLineIndex] || '').trim();
                            // If next line is a section marker (== Section ==), continue header parsing
                            // If next line is content, end header parsing
                            if (!nextLine.match(/^==\s+.*\s+==$/)) {
                                inHeader = false;
                            }
                        }
                        continue;
                    }

                    // Parse header fields
                    if (inHeader && line.includes(':')) {
                        const colonIndex = line.indexOf(':');
                        if (colonIndex !== -1) {
                            const field = (line.substring(0, colonIndex) || '').trim().toLowerCase();
                            const value = (line.substring(colonIndex + 1) || '').trim();
                            
                            switch (field) {
                                case 'contributors':
                                case 'contributor':
                                    result.contributors = value;
                                    break;
                                case 'tags':
                                case 'tag':
                                    result.tags = value;
                                    break;
                                case 'requires at least':
                                    result.requiresAtLeast = value;
                                    break;
                                case 'requires php':
                                    result.requiresPHP = value;
                                    break;
                                case 'tested up to':
                                    result.testedUpTo = value;
                                    break;
                                case 'stable tag':
                                    result.stableTag = value;
                                    break;
                                case 'license':
                                    result.license = value;
                                    break;
                            }
                        }
                        continue;
                    }

                    // Check for sections
                    if (line.match(/^== .+ ==$/)) {
                        // Save previous section
                        if (currentSection && sectionContent.length > 0) {
                            const content = sectionContent.join('\n').trim();
                            switch (currentSection) {
                                case 'description':
                                    result.description = content;
                                    break;
                                case 'installation':
                                    result.installation = content;
                                    break;
                            }
                        }
                        
                        currentSection = line.replace(/^== /, '').replace(/ ==$/, '').toLowerCase();
                        sectionContent = [];
                        continue;
                    }

                    // Check for FAQ questions
                    if (line.match(/^### .+$/)) {
                        const question = line.replace(/^### /, '').trim();
                        result.faqs.push({ question, answer: '' });
                        continue;
                    }

                    // Check for changelog versions
                    if (line.match(/^= .+ =$/)) {
                        const version = line.replace(/^= /, '').replace(/ =$/, '').trim();
                        result.changelog.push({ version, changes: [] });
                        continue;
                    }

                    // Check for changelog items
                    if (line.match(/^\* .+$/) && result.changelog.length > 0) {
                        const change = line.replace(/^\* /, '').trim();
                        result.changelog[result.changelog.length - 1].changes.push(change);
                        continue;
                    }

                    // Add to current section
                    if (currentSection && line) {
                        sectionContent.push(line);
                    }

                    // Check for short description (first non-empty line after header)
                    if (!inHeader && !currentSection && line && !result.shortDescription) {
                        result.shortDescription = line;
                    }
                }

                // Save last section
                if (currentSection && sectionContent.length > 0) {
                    const content = sectionContent.join('\n').trim();
                    switch (currentSection) {
                        case 'description':
                            result.description = content;
                            break;
                        case 'installation':
                            result.installation = content;
                            break;
                    }
                }

                return result;
            } catch (error) {
                return { error: error.message };
            }
        }

        // Test functions
        function testFileUpload() {
            const testResults = document.getElementById('testResults');
            const parsed = parseReadmeContent(sampleReadme);
            
            if (parsed.error) {
                testResults.innerHTML = '<div class="error"><h4>❌ File Parsing Failed</h4><p>' + parsed.error + '</p></div>';
            } else {
                testResults.innerHTML = '<div class="success"><h4>✅ File Parsing Successful</h4><p>Readme file parsed successfully! Plugin Name: "' + parsed.pluginName + '", Contributors: "' + parsed.contributors + '", Tags: "' + parsed.tags + '"</p></div>';
                
                // Populate form fields
                document.getElementById('pluginName').value = parsed.pluginName || '';
                document.getElementById('shortDescription').value = parsed.shortDescription || '';
                document.getElementById('contributors').value = parsed.contributors || '';
                document.getElementById('tags').value = parsed.tags || '';
                document.getElementById('version').value = parsed.stableTag || '';
                document.getElementById('requiresAtLeast').value = parsed.requiresAtLeast || '';
                document.getElementById('testedUpTo').value = parsed.testedUpTo || '';
                document.getElementById('requiresPHP').value = parsed.requiresPHP || '';
                document.getElementById('description').value = parsed.description || '';
                document.getElementById('installation').value = parsed.installation || '';
            }
        }

        function testInlinePreview() {
            const previewSection = document.getElementById('previewSection');
            const previewContent = document.getElementById('previewContent');
            
            // Generate preview content
            const parsed = parseReadmeContent(sampleReadme);
            if (!parsed.error) {
                const previewText = `=== ${parsed.pluginName} ===

Contributors: ${parsed.contributors}
Tags: ${parsed.tags}
Requires at least: ${parsed.requiresAtLeast}
Tested up to: ${parsed.testedUpTo}
Stable tag: ${parsed.stableTag}
Requires PHP: ${parsed.requiresPHP}
License: ${parsed.license}

${parsed.shortDescription}

== Description ==

${parsed.description}

== Installation ==

${parsed.installation}

== Frequently Asked Questions ==

${parsed.faqs.map(faq => `= ${faq.question} =\n\n${faq.answer || 'Answer here.'}\n\n`).join('')}

== Changelog ==

${parsed.changelog.map(entry => `= ${entry.version} =\n${entry.changes.map(change => `* ${change}`).join('\n')}\n\n`).join('')}`;
                
                previewContent.textContent = previewText;
                previewSection.style.display = 'block';
                previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function checkForModals() {
            const testResults = document.getElementById('testResults');
            const debugInfo = document.getElementById('debugInfo');
            
            // Check for modal elements
            const modalElements = document.querySelectorAll('[id*="modal"], [class*="modal"], [id*="Modal"], [class*="Modal"]');
            const modalInHTML = document.body.innerHTML.includes('modal');
            
            let debugText = 'Modal Check Results:\n';
            debugText += `Modal elements found: ${modalElements.length}\n`;
            debugText += `Modal text in HTML: ${modalInHTML}\n`;
            debugText += `Preview section display: ${document.getElementById('previewSection').style.display}\n`;
            debugText += `Preview section exists: ${document.getElementById('previewSection') ? 'Yes' : 'No'}\n`;
            
            debugInfo.textContent = debugText;
            
            if (modalElements.length === 0 && !modalInHTML) {
                testResults.innerHTML = '<div class="success"><h4>✅ No Modals Found</h4><p>Successfully removed all modal/pop-up functionality. Preview is now inline!</p></div>';
            } else {
                testResults.innerHTML = '<div class="warning"><h4>⚠️ Modals Still Present</h4><p>Found ' + modalElements.length + ' modal elements. Some modal functionality may still exist.</p></div>';
            }
        }

        function hidePreview() {
            const previewSection = document.getElementById('previewSection');
            previewSection.style.display = 'none';
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('testFileBtn').addEventListener('click', testFileUpload);
            document.getElementById('testPreviewBtn').addEventListener('click', testInlinePreview);
            document.getElementById('checkModalBtn').addEventListener('click', checkForModals);
            document.getElementById('hidePreviewBtn').addEventListener('click', hidePreview);
            
            // Run initial tests
            checkForModals();
        });
    </script>
</body>
</html>
